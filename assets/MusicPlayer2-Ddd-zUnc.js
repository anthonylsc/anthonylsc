import{j as r}from"./framer-BXmOpf2o.js";import{r as o}from"./vendor-pxwLTIeQ.js";window.__audioInstances||(window.__audioInstances=new Set);const S=(m,b=300)=>new Promise(j=>{if(!m){j();return}const I=m.volume,k=Date.now(),f=()=>{const E=Date.now()-k,h=Math.min(E/b,1);m.volume=I*(1-h),h<1?requestAnimationFrame(f):(m.volume=0,m.pause(),j())};f()}),se=o.forwardRef(function({src:b,startAt:j=253,autoPlay:I=!1,playKey:k=null,title:f="Musique",visible:E=!0,onPlayerStateChange:h=null},F){const s=o.useRef(null),[g,v]=o.useState(!1),[u,B]=o.useState(.5),[l,A]=o.useState(!1),[H,R]=o.useState(!1),x="/",[p,U]=o.useState(b??x+"music.mp3"),M=p,K=o.useRef(!1);o.useRef(null),o.useRef(b??x+"music.mp3"),o.useRef(null),o.useEffect(()=>{try{typeof h=="function"&&h({isPlaying:g,currentSrc:p})}catch{}},[g,p,h]),o.useEffect(()=>{if(window.__audioInstances||(window.__audioInstances=new Set),!s.current){try{const e=M||x+"music.mp3",n=new Audio(e);n.volume=u,n.muted=l,s.current=n,window.__audioInstances.add(n);const t=()=>v(!0),a=()=>v(!1);n.addEventListener("play",t),n.addEventListener("pause",a);const i=()=>d(n.currentTime||0),T=()=>{P(n.duration||0);try{n.currentTime=253,d(253)}catch{}};n.addEventListener("timeupdate",i),n.addEventListener("loadedmetadata",T),n.addEventListener("durationchange",T),n.preload="metadata"}catch{}return()=>{window.__audioInstances.forEach(e=>{try{e.pause(),e.src="",e.currentTime=0}catch{}}),window.__audioInstances.clear(),s.current=null}}},[]),o.useEffect(()=>{if(s.current)try{s.current.volume=u,s.current.muted=l}catch{}},[u,l]);const[_,d]=o.useState(0),[y,P]=o.useState(0),[W,G]=o.useState(0),[N,J]=o.useState(0),w=o.useRef(null);o.useEffect(()=>{const e=s.current;if(!e)return;const n=()=>d(e.currentTime||0),t=()=>P(e.duration||0);return e.addEventListener("timeupdate",n),e.addEventListener("loadedmetadata",t),e.addEventListener("durationchange",t),()=>{try{e.removeEventListener("timeupdate",n)}catch{}try{e.removeEventListener("loadedmetadata",t)}catch{}try{e.removeEventListener("durationchange",t)}catch{}}},[s.current]),o.useEffect(()=>{w.current&&cancelAnimationFrame(w.current);const e=y?Math.min(100,Math.max(0,_/y*100)):0,n=()=>{G(t=>{const a=_-t;return Math.abs(a)>.5?_:t+a*.15}),J(t=>{const a=e-t;return Math.abs(a)>2?e:t+a*.15}),w.current=requestAnimationFrame(n)};return w.current=requestAnimationFrame(n),()=>{w.current&&cancelAnimationFrame(w.current)}},[_,y]);const C=async()=>{console.log("handleToggle called, audioRef.current:",s.current?"exists":"null");const e=s.current;if(!e){console.warn("No audio instance to toggle");return}const n=!e.paused;if(console.log("isCurrentlyPlaying:",n,"a.paused:",e.paused),n){console.log("Calling pause with fade...");try{await S(e,200),e.volume=.5,window.__audioInstances.forEach(t=>{if(t!==e)try{t.pause(),t.currentTime=0,t.src=""}catch{}})}catch(t){console.error("Pause error:",t)}v(!1)}else{console.log("Calling play...");try{if(window.__audioInstances.forEach(t=>{if(t!==e)try{t.pause(),t.currentTime=0,t.src=""}catch{}}),!e.src||e.src==="")try{const t=p||M||x+"music.mp3";console.log("Setting audio src to:",t),e.src=t,e.load(),await new Promise(a=>setTimeout(a,100))}catch{}try{if(await e.play(),e.src&&e.src.includes("music.mp3"))try{e.currentTime=253}catch{}}catch(t){if(console.warn("Play attempt failed, retrying if possible",t),!e.src||t.name==="NotSupportedError")try{const a=p||M||x+"music.mp3";if(console.log("Retry: Setting audio src to:",a),e.src=a,e.load(),await new Promise(i=>setTimeout(i,150)),await e.play(),e.src&&e.src.includes("music.mp3"))try{e.currentTime=253}catch{}}catch(a){console.error("Play retry failed",a)}}}catch(t){console.error("Play failed",t)}}},Q=e=>{const n=Number(e.target.value);B(n),s.current&&(s.current.volume=n)},X=()=>{const e=s.current;if(!e)return;const n=!e.muted;try{e.muted=n}catch{}A(n)},Y=e=>{const n=Number(e.target.value);if(s.current&&!Number.isNaN(n)){try{s.current.currentTime=n}catch{}d(n)}},q=e=>{if(!e)return"0:00";const n=Math.floor(e/60),t=Math.floor(e%60).toString().padStart(2,"0");return`${n}:${t}`},Z=Math.min(100,Math.max(0,l?0:u*100)),O=f&&f!=="Musique"?`Musique - ${f}`:"Musique";return o.useImperativeHandle(F,()=>({toggle:C,getIsPlaying:()=>g,getCurrentSrc:()=>p,stop:async()=>{try{if(s.current)if(await S(s.current,300),s.current.src&&s.current.src.includes("music.mp3"))try{s.current.currentTime=253,d(253)}catch{}else s.current.currentTime=0,d(0)}catch(e){console.warn("Stop failed",e)}},play:async(e,n=null,t=0)=>{try{if(console.log("MusicPlayer2 play() called with newSrc:",e),!e){console.warn("No source provided for play");return}K.current=!0;const a=Array.from(window.__audioInstances);await Promise.all(a.map(c=>S(c,250).then(()=>{try{c.currentTime=0,c.src="",window.__audioInstances.delete(c)}catch{}}).catch(()=>{try{c.pause(),c.currentTime=0,c.src="",window.__audioInstances.delete(c)}catch{}})));const i=new Audio(e);i.volume=u,l&&(i.muted=!0);const T=()=>{console.log("Audio onPlay event fired"),v(!0)},D=()=>{console.log("Audio onPause event fired"),v(!1)};i.addEventListener("play",T),i.addEventListener("pause",D);const ee=()=>d(i.currentTime||0),V=()=>P(i.duration||0);if(i.addEventListener("timeupdate",ee),i.addEventListener("loadedmetadata",V),i.addEventListener("durationchange",V),t!=null&&typeof t=="number"&&t>0)try{i.currentTime=t}catch{}s.current=i,window.__audioInstances.add(i),U(e),console.log("About to call play()...");try{i.volume=0,await i.play(),console.log("play() succeeded");const c=l?0:u,L=Date.now(),te=300,z=()=>{const ne=Date.now()-L,$=Math.min(ne/te,1);i.volume=c*$,$<1&&requestAnimationFrame(z)};z()}catch(c){console.warn("Play failed (imperative)",c)}}catch(a){console.error("Player play error",a)}}})),r.jsx("div",{className:`fixed left-1/2 transform -translate-x-1/2 bottom-6 z-50 w-[92%] max-w-3xl transition-all duration-300 ${E?"opacity-100 pointer-events-auto":"opacity-0 pointer-events-none"}`,children:r.jsxs("div",{className:"music-card flex items-center gap-4 px-4 py-3 rounded-3xl bg-gradient-to-r from-white/6 to-white/4 backdrop-blur-xl border border-white/10 shadow-lg text-white relative transition-all duration-300 hover:border-white/20",children:[r.jsx("button",{onClick:C,className:"player-play-btn w-14 h-14 rounded-full flex items-center justify-center text-2xl bg-gradient-to-br from-purple-600 to-violet-500 shadow-md",children:g?r.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",children:[r.jsx("rect",{x:"5",y:"4",width:"4",height:"16",fill:"white",rx:"1"}),r.jsx("rect",{x:"15",y:"4",width:"4",height:"16",fill:"white",rx:"1"})]}):r.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",children:r.jsx("path",{d:"M5 3v18l15-9L5 3z",fill:"white"})})}),r.jsxs("div",{className:"flex-1 min-w-0",children:[r.jsxs("div",{className:"flex items-center justify-between mb-2",children:[r.jsxs("div",{className:"truncate",children:[r.jsx("div",{className:"text-sm font-semibold transition-all duration-300",children:O}),r.jsx("div",{className:"text-xs text-gray-300 transition-all duration-300",children:g?"En cours":"En pause"})]}),r.jsxs("div",{className:"text-xs text-gray-300 transition-all duration-300 tabular-nums",children:[q(W)," / ",q(y)]})]}),r.jsx("input",{type:"range",min:0,max:y||0,step:.1,value:N>0?N/100*y:_,onChange:Y,className:"player-range",style:{background:"linear-gradient(90deg, rgba(147,51,234,0.95) 0%, rgba(99,102,241,0.95) 100%)",backgroundSize:`${N}% 100%`,backgroundRepeat:"no-repeat"}})]}),r.jsx("div",{className:"relative flex-shrink-0",onMouseEnter:()=>R(!0),onMouseLeave:()=>R(!1),children:r.jsxs("div",{className:"relative flex items-center",children:[r.jsx("button",{onClick:X,className:"w-10 h-10 rounded-full flex items-center justify-center bg-white/3 hover:bg-white/5 transition-colors z-20",children:l?r.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",children:[r.jsx("path",{d:"M16 7v10a1 1 0 0 1-1.6.8L11 15H8a1 1 0 0 1-1-1V10a1 1 0 0 1 1-1h3l3.4-3.8A1 1 0 0 1 16 7z",fill:"white"}),r.jsx("path",{d:"M19 5l-2 2m0 10 2 2",stroke:"white",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round"})]}):r.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",children:r.jsx("path",{d:"M5 9v6h4l5 4V5L9 9H5z",fill:"white"})})}),r.jsx("div",{className:`absolute top-1/2 left-full ml-3 transform -translate-y-1/2 w-40 transition-all duration-300 ${H?"opacity-100 pointer-events-auto":"opacity-0 pointer-events-none"}`,children:r.jsx("input",{type:"range",min:0,max:1,step:.01,value:l?0:u,onChange:e=>{Q(e),A(!1)},className:"player-range-mini",style:{background:"linear-gradient(90deg, rgba(147,51,234,0.95) 0%, rgba(99,102,241,0.95) 100%)",backgroundSize:`${Z}% 100%`,backgroundRepeat:"no-repeat"}})})]})})]})})});export{se as default};
